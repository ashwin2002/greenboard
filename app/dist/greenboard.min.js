/*! greenboard 2015-11-28 */
function getPercOfVal(a,b){if(!a)return 0;var c=a.Passed+a.Failed;return 0==c?0:Math.floor(100*(b/c).toFixed(2))}function getPercOfValStr(a,b){return getPercOfVal(a,b)+"%"}function getItemPerc(a){if(!a)return 0;var b=a.Passed+a.Failed,c=b+a.Pending;return 0==c?0:Math.floor(100*(b/c).toFixed(2))}function getItemPercStr(a){return getItemPerc(a)+"%"}!function(){"use strict";angular.module("plotly",[]).directive("plotly",["Data","PASS_BAR_STYLE","FAIL_BAR_STYLE","CHART_LAYOUT","CHART_OPTIONS",function(a,b,c,d,e){return{restrict:"E",template:"<div></div>",scope:{onChange:"="},link:function(f,g){var g=g[0].children[0],h=a.getVersionBuilds(),i=(a.getBuild(),b),j=c,k=h.filter(function(a){return a.Passed+a.Failed>200});i.x=j.x=k.map(function(a){return a.build}),i.y=k.map(function(a){return a.Passed}),j.y=k.map(function(a){return a.Failed});var l=[i,j],m=e,n=d;n.title=a.getBuild(),Plotly.newPlot(g,l,n,m),$("#builds").bind("plotly_click",function(a,b){f.onChange(b.points[0].x)})}}}]).value("PASS_BAR_STYLE",{x:[],y:[],type:"bar",name:"Pass",marker:{color:"rgba(59, 201, 59, 0.70)"}}).value("FAIL_BAR_STYLE",{x:[],y:[],type:"bar",name:"Fail",marker:{color:"rgba(222, 0, 0, 0.70)"}}).value("CHART_LAYOUT",{height:300,width:800,title:""}).value("CHART_OPTIONS",{showLink:!1,displayLogo:!1})}();var app=angular.module("greenBoard",["plotly","ui.router","svc.data","svc.query","app.main","app.target","app.sidebar"]);app.config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/server/4.1.0/latest"),a.state("target",{url:"/:target","abstract":!0,template:"<ui-view/>",resolve:{target:["$stateParams",function(a){return a.target}],targetVersions:["$stateParams","Data","QueryService",function(a,b,c){var d=a.target,e=b.getTargetVersions(d);return e||(e=c.getVersions(d)),e}]}}).state("target.version",{url:"/:version/:build",templateUrl:"view.html",controller:"NavCtrl",resolve:{version:["$stateParams","$location","targetVersions","target",function(a,b,c,d){var e=a.version;return("latest"==e||-1==c.indexOf(e))&&(e=c[c.length-1],b.path(d+"/"+e)),e}],build:["$stateParams",function(a){return a.build}]}}).state("target.version.build",{templateUrl:"partials/builds.html",controller:"BuildCtrl",resolve:{versionBuilds:["QueryService","target","version",function(a,b,c){return a.getBuilds(b,c)}]}}).state("target.version.build.jobs",{templateUrl:"partials/jobs.html",controller:"JobsCtrl",resolve:{buildJobs:["QueryService","target","Data","version",function(a,b,c,d){var e=c.getBuild();return a.getJobs(e,b)}]}})}]),angular.module("svc.data",[]).provider("Data",[function(){this.versions=[],this.target="server",this.version=null,this.versions=[],this.build=null,this.builds=[],this.buildJobs={},this.buildBreakdown={},this.$get=function(){return _targetVersions={},_buildJobs=[],_buildBreakdown=[],{setTarget:function(a){this.target=a},setTargetVersions:function(a){this.target&&(_targetVersions[this.target]=a),this.versions=a},setSelectedVersion:function(a){this.version=a},setBuild:function(a){this.build=a},setVersionBuilds:function(a){this.builds=a},setBuildJobs:function(a,b){b=b||this.build,_buildJobs=a},setBuildBreakdown:function(a,b){b=b||this.build,_buildBreakdown=a},getBuildBreakdown:function(a){return _buildBreakdown},getBuildJobs:function(a){return _buildJobs},getCurrentTarget:function(){return this.target},getTargetVersions:function(a){var b=this.versions;return a&&(b=_targetVersions[a]),b},getSelectedVersion:function(){return this.version},getBuild:function(){var a=this.build;return"latest"==a&&this.builds.length>0&&(a=this.builds[this.builds.length-1]),a&&-1==a.indexOf("-")&&(a=this.version+"-"+a),a},getVersionBuilds:function(){return this.builds}}}}]),angular.module("app.main",[]).controller("NavCtrl",["$scope","$state","$stateParams","Data","target","targetVersions","version",function(a,b,c,d,e,f,g){d.setTarget(e),d.setSelectedVersion(g),d.setTargetVersions(f),b.go("target.version.build"),a.changeTarget=function(a){b.go("target.version",{target:a,version:"latest"})},a.changeVersion=function(a){b.go("target.version",{version:a,build:"latest"})}}]).controller("BuildCtrl",["$scope","$state","build","versionBuilds","Data",function(a,b,c,d,e){e.setVersionBuilds(d),"latest"==c&&d.length>0&&(c=d[d.length-1].build),e.setBuild(c),b.go("target.version.build.jobs"),a.onChange=function(a){a=a.split("-")[1],a!=c&&b.go("target.version",{build:a})}}]).controller("JobsCtrl",["$scope","$state","Data","buildJobs",function(a,b,c,d){function e(a){return _.mapValues(a,function(a,b){var c=_.sum(_.pluck(a,"totalCount")),d=_.sum(_.pluck(a,"failCount"));return{key:b,Passed:c-d,Failed:d,Pending:_.sum(_.pluck(a,"pending"))}})}if(0!=d.length){c.setBuildJobs(d),a.jobs=d;var f=_.groupBy(d,"os"),g=e(f),h=_.groupBy(d,"component"),i=e(h),j=_.values(g),k=_.reduce(j,function(a,b){return{Passed:a.Passed+b.Passed,Failed:a.Failed+b.Failed,Pending:a.Pending+b.Pending}});k.Platforms=j,k.Features=_.values(i),c.setBuildBreakdown(k),a.msToTime=function(a){var b=(parseInt(a%1e3/100),parseInt(a/1e3%60)),c=parseInt(a/6e4%60),d=parseInt(a/36e5%24);return d=10>d?"0"+d:d,c=10>c?"0"+c:c,b=10>b?"0"+b:b,d+":"+c+":"+b}}}]),angular.module("svc.query",[]).service("QueryService",["$http","Data",function(a,b){return{getVersions:function(b){var c=["versions",b].join("/");return a({url:c,cache:!0}).then(function(a){return a.data})},getBuilds:function(b,c){var d=["builds",b,c].join("/");return a({url:d,cache:!0}).then(function(a){return a.data})},getJobs:function(b,c){var d=["jobs",b,c].join("/");return a({url:d,cache:!0}).then(function(a){return a.data})},getBuildBreakdown:function(b,c){var d=["breakdown",b,c].join("/");return a({url:d,cache:!0}).then(function(a){return a.data})}}}]),angular.module("app.sidebar",[]).directive("buildSidebar",["Data",function(a){return{restrict:"E",scope:{onClick:"="},templateUrl:"partials/sidebar.html",link:function(b,c,d){b.showPerc=!1,b.$watch(function(){return a.getBuildBreakdown()},function(c){c&&(c.Version=a.getBuild(),b.build=c)})}}}]).directive("sidebarItem",[function(){return{restrict:"E",scope:{item:"=",title:"=",asNum:"=showPerc"},templateUrl:"partials/sidebar_item.html",link:function(a,b,c){a.getNumOrPerc=function(b){var c=a.asNum,d=a.item;return d?"pass"==b?c?d.Passed:getPercOfValStr(d,d.Passed):"fail"==b?c?d.Failed:getPercOfValStr(d,d.Failed):"pend"==b?c?d.Pending:getPercOfValStr(d,d.Pending):void 0:void 0},a.getRunPercent=function(){return getItemPercStr(a.item)},passPerc=a.getNumOrPerc("pass"),100==passPerc?a.bgColor="bg-success":passPerc>=70?a.bgColor="bg-warning":a.bgColor="bg-danger"}}}]),angular.module("app.target",[]).directive("targetSelector",["$state","ViewTargets","Data",function(a,b,c){return{restrict:"E",scope:{changeTarget:"="},templateUrl:"partials/targets.html",link:function(a,d,e){a.$watch(function(){return c.getCurrentTarget()},function(c){c&&(a.viewTargets=b.allTargets(),a.targetBy=b.getTarget(c))})}}}]).directive("versionSelector",["$stateParams","ViewTargets","QueryService","Data",function(a,b,c,d){return{restrict:"E",templateUrl:"partials/versions.html",scope:{changeVersion:"="},link:function(a,b,c){a.$watch(function(){return d.getSelectedVersion()},function(b){b&&(a.version=b,a.targetVersions=d.getTargetVersions())})}}}]).factory("ViewTargets",["COUCHBASE_TARGET","SDK_TARGET","MOBILE_TARGET",function(a,b,c){var d=[a,b,c],e={};return d=d.map(function(a,b){return a.i=b,e[a.bucket]=a,a}),{allTargets:function(){return d},getTarget:function(a){return e[a]}}}]).value("COUCHBASE_TARGET",{title:"Couchbase Server",bucket:"server",key:"abspassed",value:100,options:[0,50,100,500]}).value("SDK_TARGET",{title:"SDK",bucket:"sdk",key:"abspassed",value:100,options:[0,50,100,500]}).value("MOBILE_TARGET",{title:"Mobile",bucket:"mobile",key:"abspassed",value:0,options:[0,50,100,500]});