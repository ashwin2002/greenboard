/*! greenboard 2015-11-19 */
"usev strict";var app=angular.module("greenBoard",["ui.router","svc.data","svc.query","ctrl.main","app.target","app.timeline"]);app.config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/server/latest"),a.state("main",{url:"/:target/:version",templateUrl:"view.html",controller:"MainCtrl"})}]),angular.module("svc.data",[]).provider("Data",[function(){this.versions=[],this.target="server",this.version=null,this.versions=[],this.$get=function(){return{setTarget:function(a){this.target=a},setTargetVersions:function(a){this.versions=a},setSelectedVersion:function(a){this.version=a},getCurrentTarget:function(){return this.target},getTargetVersions:function(){return this.versions},getSelectedVersion:function(){return this.version}}}}]),angular.module("ctrl.main",[]).controller("MainCtrl",["$scope","$stateParams","Data","QueryService",function(a,b,c,d){function e(e){a.target=e,c.setTarget(a.target),d.getVersions(a.target).then(function(d){var e=b.version;"latest"==e?a.version=d[d.length-1]:a.version=e,c.setTargetVersions(d),c.setSelectedVersion(a.version)})}a.changeTarget=function(a){e(a)},a.changeVersion=function(b){a.version=b,c.setSelectedVersion(a.version)},e(b.target)}]),angular.module("app.timeline",["plotly"]).controller("TimelineCtrl",["$scope","QueryService","ViewTargets","selectedVersion","PASS_BAR_STYLE","FAIL_BAR_STYLE","CHART_LAYOUT","CHART_OPTIONS",function(a,b,c,d,e,f,g,h){var i=c.currentTarget,j=e,k=f;a.data=[j,k],a.options=h,a.layout=g,a.layout.title=d,b.getBuilds(i,d).then(function(b){b=b.filter(function(a){return a.Passed+a.Failed>200}),j.x=k.x=b.map(function(a){return a.build}),j.y=b.map(function(a){return a.Passed}),k.y=b.map(function(a){return a.Failed}),a.data[0]=j,a.data[1]=k})}]).value("PASS_BAR_STYLE",{x:[],y:[],type:"bar",name:"Pass",marker:{color:"rgba(59, 201, 59, 0.70)"}}).value("FAIL_BAR_STYLE",{x:[],y:[],type:"bar",name:"Fail",marker:{color:"rgba(222, 0, 0, 0.70)"}}).value("CHART_LAYOUT",{height:300,width:800,title:""}).value("CHART_OPTIONS",{showLink:!1,displayLogo:!1}),angular.module("svc.query",[]).service("QueryService",["$http","Data",function(a,b){return{getVersions:function(b){var c=["versions",b].join("/");return a({url:c,cache:!0}).then(function(a){return a.data})},getBuilds:function(b,c){var d=["builds",b,c].join("/");return a({url:d,cache:!0}).then(function(a){return a.data})}}}]),angular.module("ctl.sidebar",[]).controller("SidebarCtrl",["$scope","ViewService","Data","$location",function(a,b,c,d){function e(b,c){var d,e;"c"==c?(e=b.Category,d=a.Categories[e]):(e=b.Platform,d=a.Platforms[e]),d.checked?d.Status="greyed":d.Status="bg-success",d.checked=!d.checked}a.data=c,a.showAsPerc=!0,a.showAllPlatforms=!0,a.showAllCategories=!0,a.PlatformsList=[],a.CategoriesList=[],a.didFirstSort=!1,a.orderByPerc=function(b){return a.didFirstSort?b.sortOrder:(b.sortOrder=-100*a.getPerc(b),b.sortOrder)},a.objAsList=function(a){var b=[];for(var c in a)b.push(a[c]);return b};var f=function(){a.selectedVersion=c.selectedVersion,a.build=c.selectedBuildObj,a.build.Passed=0,a.build.Failed=0,a.build.Pending=0,a.showAllPlatforms=!0,a.showAllCategories=!0,c.selectedBuildObj&&(a.Platforms={},a.Categories={},i().then(function(){var a=d.search(),b=!1;if("excluded_platforms"in a){b=!0;var c=a.excluded_platforms.split(",");c.forEach(function(a){e({Platform:a},"p")})}if("excluded_categories"in a){b=!0;var f=a.excluded_categories.split(",");f.forEach(function(a){e({Category:a},"c")})}b&&j()}))};a.$watch("data.refreshSidebar",function(b,d){1==b?(f(),c.refreshSidebar=!1):a.didFirstSort=!1}),a.didClickSlider=function(){a.showAsPerc=!a.showAsPerc},a.getPercVal=function(a,b){if(!a)return 0;var c=a.Passed+a.Failed;return 0==c?0:100*(b/c)},a.getPerc=function(a){if(!a)return 0;var b=a.Passed+a.Failed,c=b+a.Pending;return 0==c?0:b/c};var g=function(b){a.Categories[b.Category].Passed+=b.Passed,a.Categories[b.Category].Failed+=b.Failed,a.Categories[b.Category].Pending+=b.Pending,a.Platforms[b.Platform].Passed+=b.Passed,a.Platforms[b.Platform].Failed+=b.Failed,a.Platforms[b.Platform].Pending+=b.Pending,a.build.Passed+=b.Passed,a.build.Failed+=b.Failed,a.build.Pending+=b.Pending},h=function(b){var c="bg-success",d="bg-warning",e="bg-danger";if("greyed"!=a.Platforms[b.Platform].Status){var f=a.Platforms[b.Platform].Failed;if(f>0){var g=a.Platforms[b.Platform].Passed,h=100*f/(f+g);h>30?a.Platforms[b.Platform].Status=e:a.Platforms[b.Platform].Status=d}else a.Platforms[b.Platform].Status=c}if(0==a.Platforms[b.Platform].Passed&&0==a.Platforms[b.Platform].Failed&&(a.Platforms[b.Platform].Status="disabled"),"greyed"!=a.Categories[b.Category].Status){var f=a.Categories[b.Category].Failed;if(f>0){var g=a.Categories[b.Category].Passed,h=100*f/(f+g);h>30?a.Categories[b.Category].Status=e:a.Categories[b.Category].Status=d}else a.Categories[b.Category].Status=c}0==a.Categories[b.Category].Passed&&0==a.Categories[b.Category].Failed&&(a.Categories[b.Category].Status="disabled");var f=a.build.Failed;if(0==f)a.build.Status=c;else{var g=a.build.Passed,h=100*f/(f+g);h>30?a.build.Status=e:a.build.Status=d}},i=function(d,e){return b.breakdown(c.selectedBuildObj.Version,d,e).then(function(b){b.forEach(function(b){b.Category in a.Categories||(a.Categories[b.Category]={Category:b.Category,Passed:0,Failed:0,Pending:0,Status:"bg-success",checked:!0}),b.Platform in a.Platforms||(a.Platforms[b.Platform]={Platform:b.Platform,Passed:0,Failed:0,Pending:0,Status:"bg-success",checked:!0}),g(b),h(b)})})},j=function(){c.selectedBuildObj.Version;a.build.Passed=0,a.build.Failed=0,a.build.Pending=0,a.build.Status="bg-success";var b=[],e=[];Object.keys(a.Categories).forEach(function(b){var c=a.Categories[b];c.Passed=0,c.Failed=0,c.Pending=0,"greyed"==c.Status?e.indexOf(b)<0&&e.push(b):c.Status="disabled"}),Object.keys(a.Platforms).forEach(function(c){var d=a.Platforms[c];d.Passed=0,d.Failed=0,d.Pending=0,"greyed"==d.Status?b.indexOf(c)<0&&b.push(c):d.Status="disabled"}),b.length>0&&b.length==Object.keys(a.Platforms).length?a.showAllPlatforms=!1:0==b.length&&(a.showAllPlatforms=!0),e.length>0&&e.length==Object.keys(a.Categories).length?a.showAllCategories=!1:0==e.length&&(a.showAllCategories=!0);var f=null,g=null;return b.length>0&&(f=b.toString()),e.length>0&&(g=e.toString()),d.search("excluded_platforms",f),d.search("excluded_categories",g),c.refreshJobs=!0,i(b,e)};a.toggleAll=function(b){var c;"c"==b?(c=a.Categories,a.showAllCategories=!a.showAllCategories):(c=a.Platforms,a.showAllPlatforms=!a.showAllPlatforms),Object.keys(c).forEach(function(d){var f=c[d];"c"==b?f.checked=!a.showAllCategories:f.checked=!a.showAllPlatforms,e(f,b)}),j()},a.toggleItem=function(b,c){if(a.didFirstSort=!0,"c"==c){var d=Object.keys(a.Categories),f=d.filter(function(b){return a.Categories[b].checked});f.length>1&&f.length==d.length&&a.toggleAll("c")}else{var g=Object.keys(a.Platforms),f=g.filter(function(b){return a.Platforms[b].checked});f.length>1&&f.length==g.length&&a.toggleAll("p")}e(b,c),j()}}]),angular.module("app.target",[]).directive("targetSelector",["$stateParams","ViewTargets","Data",function(a,b,c){return{restrict:"E",scope:{target:"=",changeTarget:"="},templateUrl:"partials/targets.html",link:function(a,c,d){a.$watch(d.target,function(c){c&&(a.viewTargets=b.allTargets(),a.targetBy=b.getTarget(c))})}}}]).directive("versionSelector",["$stateParams","ViewTargets","QueryService","Data",function(a,b,c,d){return{restrict:"E",templateUrl:"partials/versions.html",scope:{version:"=",changeVersion:"="},link:function(a,b,c){a.$watch(c.version,function(b){b&&(a.targetVersions=d.getTargetVersions())})}}}]).factory("ViewTargets",["COUCHBASE_TARGET","SDK_TARGET","MOBILE_TARGET",function(a,b,c){var d=[a,b,c],e={};return d=d.map(function(a,b){return a.i=b,e[a.bucket]=a,a}),{allTargets:function(){return d},getTarget:function(a){return e[a]}}}]).value("COUCHBASE_TARGET",{title:"Couchbase Server",bucket:"server",key:"abspassed",value:100,options:[0,50,100,500]}).value("SDK_TARGET",{title:"SDK",bucket:"sdk",key:"abspassed",value:100,options:[0,50,100,500]}).value("MOBILE_TARGET",{title:"Mobile",bucket:"mobile",key:"abspassed",value:0,options:[0,50,100,500]}),angular.module("app.timeline",["plotly"]).controller("TimelineCtrl",["$scope","QueryService","Data","PASS_BAR_STYLE","FAIL_BAR_STYLE","CHART_LAYOUT","CHART_OPTIONS",function(a,b,c,d,e,f,g){var h=d,i=e;a.data=[h,i],a.options=g,a.layout=f,a._data=c,a.$watch("_data.getSelectedVersion()",function(d){if(d){var e=c.getCurrentTarget();a.layout.title=d,b.getBuilds(e,d).then(function(b){b=b.filter(function(a){return a.Passed+a.Failed>200}),h.x=i.x=b.map(function(a){return a.build}),h.y=b.map(function(a){return a.Passed}),i.y=b.map(function(a){return a.Failed}),a.data[0]=h,a.data[1]=i})}})}]).value("PASS_BAR_STYLE",{x:[],y:[],type:"bar",name:"Pass",marker:{color:"rgba(59, 201, 59, 0.70)"}}).value("FAIL_BAR_STYLE",{x:[],y:[],type:"bar",name:"Fail",marker:{color:"rgba(222, 0, 0, 0.70)"}}).value("CHART_LAYOUT",{height:300,width:800,title:""}).value("CHART_OPTIONS",{showLink:!1,displayLogo:!1});