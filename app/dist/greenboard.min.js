/*! greenboard 2015-11-18 */
"usev strict";function lastEl(a){return a.length>0?a[a.length-1]:a[0]}function msToTime(a){var b=(parseInt(a%1e3/100),parseInt(a/1e3%60)),c=parseInt(a/6e4%60),d=parseInt(a/36e5%24);return d=10>d?"0"+d:d,c=10>c?"0"+c:c,b=10>b?"0"+b:b,d+":"+c+":"+b}function lastEl(a){return a.length>0?a[a.length-1]:a[0]}var app=angular.module("greenBoard",["ui.router","svc.data","svc.view","svc.query","ctl.main","ctl.version","ctl.timeline","ctl.initdata","ctl.sidebar","ctl.jobs"]);app.config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/server/latest"),a.state("target",{url:"/:target",views:{sidebar:{templateUrl:"partials/sidebar.html",controller:"SidebarCtrl"},main:{templateUrl:"view.html",controller:"MainCtrl"}},resolve:{versions:["QueryService","$stateParams",function(a,b){var c=b.target;return a.getVersions(c)}]}}).state("target.version",{url:"/:version",controller:"VersionCtrl",resolve:{selectedVersion:["$stateParams","versions",function(a,b){var c=a.version;return"latest"==c&&(c=b[b.length-1]),c}]}})}]),function(){d3.legend=function(a){return a.each(function(){var a=d3.select(this),b={},c=d3.select(a.property("nearestViewportElement")),d=a.attr("data-style-padding")||5,e=a.selectAll(".legend-box").data([!0]),f=a.selectAll(".legend-items").data([!0]);e.enter().append("rect").classed("legend-box",!0),f.enter().append("g").classed("legend-items",!0),c.selectAll("[data-legend]").each(function(){var a=d3.select(this);b[a.attr("data-legend")]={pos:a.attr("data-legend-pos")||this.getBBox().y,color:void 0!=a.attr("data-legend-color")?a.attr("data-legend-color"):"none"!=a.style("fill")?a.style("fill"):a.style("stroke")}}),b=d3.entries(b).sort(function(a,b){return a.value.pos-b.value.pos}),f.selectAll("text").data(b,function(a){return a.key}).call(function(a){a.enter().append("text")}).call(function(a){a.exit().remove()}).attr("y",function(a,b){return b+"em"}).attr("x","1em").text(function(a){return a.key}),f.selectAll("circle").data(b,function(a){return a.key}).call(function(a){a.enter().append("circle")}).call(function(a){a.exit().remove()}).attr("cy",function(a,b){return b-.25+"em"}).attr("cx",0).attr("r","0.4em").style("fill",function(a){return a.value.color});var g=f[0][0].getBBox();e.attr("x",g.x-d).attr("y",g.y-d).attr("height",g.height+2*d).attr("width",g.width+2*d)}),a}}(),d3.tip=function(){function a(a){t=n(a),u=t.createSVGPoint(),document.body.appendChild(s)}function b(){return"n"}function c(){return[0,0]}function d(){return" "}function e(){var a=o();return{top:a.n.y-s.offsetHeight,left:a.n.x-s.offsetWidth/2}}function f(){var a=o();return{top:a.s.y,left:a.s.x-s.offsetWidth/2}}function g(){var a=o();return{top:a.e.y-s.offsetHeight/2,left:a.e.x}}function h(){var a=o();return{top:a.w.y-s.offsetHeight/2,left:a.w.x-s.offsetWidth}}function i(){var a=o();return{top:a.nw.y-s.offsetHeight,left:a.nw.x-s.offsetWidth}}function j(){var a=o();return{top:a.ne.y-s.offsetHeight,left:a.ne.x}}function k(){var a=o();return{top:a.sw.y,left:a.sw.x-s.offsetWidth}}function l(){var a=o();return{top:a.se.y,left:a.e.x}}function m(){var a=d3.select(document.createElement("div"));return a.style({position:"absolute",opacity:0,pointerEvents:"none",boxSizing:"border-box"}),a.node()}function n(a){return a=a.node(),"svg"==a.tagName.toLowerCase()?a:a.ownerSVGElement}function o(){var a=v||d3.event.target,b={},c=a.getScreenCTM(),d=a.getBBox(),e=d.width,f=d.height,g=d.x,h=d.y,i=document.documentElement.scrollTop||document.body.scrollTop,j=document.documentElement.scrollLeft||document.body.scrollLeft;return u.x=g+j,u.y=h+i,b.nw=u.matrixTransform(c),u.x+=e,b.ne=u.matrixTransform(c),u.y+=f,b.se=u.matrixTransform(c),u.x-=e,b.sw=u.matrixTransform(c),u.y-=f/2,b.w=u.matrixTransform(c),u.x+=e,b.e=u.matrixTransform(c),u.x-=e/2,u.y-=f/2,b.n=u.matrixTransform(c),u.y+=f,b.s=u.matrixTransform(c),b}var p=b,q=c,r=d,s=m(),t=null,u=null,v=null;a.show=function(){var b=Array.prototype.slice.call(arguments);b[b.length-1]instanceof SVGElement&&(v=b.pop());var c,d=r.apply(this,b),e=q.apply(this,b),f=p.apply(this,b),g=d3.select(s),h=0;for(g.html(d).style({opacity:1,"pointer-events":"all"});h--;)g.classed(x[h],!1);return c=w.get(f).apply(this),g.classed(f,!0).style({top:c.top+e[0]+"px",left:c.left+e[1]+"px"}),a},a.hide=function(){return nodel=d3.select(s),nodel.style({opacity:0,"pointer-events":"none"}),a},a.attr=function(b,c){if(arguments.length<2&&"string"==typeof b)return d3.select(s).attr(b);var d=Array.prototype.slice.call(arguments);return d3.selection.prototype.attr.apply(d3.select(s),d),a},a.style=function(b,c){if(arguments.length<2&&"string"==typeof b)return d3.select(s).style(b);var d=Array.prototype.slice.call(arguments);return d3.selection.prototype.style.apply(d3.select(s),d),a},a.direction=function(b){return arguments.length?(p=null==b?b:d3.functor(b),a):p},a.offset=function(b){return arguments.length?(q=null==b?b:d3.functor(b),a):q},a.html=function(b){return arguments.length?(r=null==b?b:d3.functor(b),a):r};var w=d3.map({n:e,s:f,e:g,w:h,nw:i,ne:j,sw:k,se:l}),x=w.keys();return a},angular.module("dir.d3",[]).directive("barChart",["Data","$location",function(a,b){function c(c,d,j){var k=d[0].values,l=d[1].values,m=(a.versionBuilds.indexOf(a.selectedBuildObj),k.length);stack=d3.layout.stack();var n=["#3bc93b","#de0000"];layers=function(a,b){return[{name:"passed",x:0,values:a.map(function(a,b){return{x:b,y:a[1],y0:0,bno:a[0],cc:n[0]}})},{name:"failed",x:0,values:b.map(function(a,b){return{x:b,y:-1*a[1],y0:0,bno:a[0],cc:n[1]}})}]},yGroupMax=d3.max(k,function(a){return a[1]});var o=d3.scale.ordinal().domain(k.map(function(a){return a[0]})).rangeRoundBands([0,g],.08),p=d3.scale.ordinal().domain(k.map(function(a){return a[0]})).rangeRoundBands([0,g],.08),q=d3.scale.linear().domain([0,yGroupMax]).range([h,0]),r=(d3.scale.linear().domain([0,yGroupMax]).range([i,0]),Math.floor(g/p.domain().length)),s=d3.select(j).append("svg").attr("width",g+e.left+e.right).attr("height",h+150);s.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",g).attr("height",g);var t=s.append("g").attr("class","focus").attr("transform","translate("+e.left+","+e.top+")"),u=s.append("g").attr("class","context").attr("transform","translate("+f.left+","+f.top+")"),v=function(a){var b=1;return a.length>10&&(b=Math.floor(m/10)),a.filter(function(a,c){return c%b==0}).map(function(a){return a[0]})},w=d3.svg.axis().scale(o).tickValues(v(k)).tickSize(0).tickPadding(6).orient("bottom"),x=d3.svg.axis().scale(p).tickFormat("").tickSize(0).tickPadding(6).orient("bottom"),y=d3.svg.axis().scale(q).tickSize(-g,0,0).tickPadding(6).orient("left").ticks(3),z=function(b){var c=a.selectedBuildObj.Version.split("-")[1];return c==b.bno?1:.5},A=t.selectAll(".layer").data(layers(k,l));A.enter().append("g").attr("class","layer").style("fill",function(a,b){return n[b]}).attr("data-legend",function(a){return a.name});var B=(s.append("g").attr("class","legend").attr("transform","translate("+g+", 20)").style("font-size","12px").call(d3.legend),d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(a,b){var c=k[b][1],d=-1*l[b][1];return"<div class='tip'><h4>passed: "+c+" failed: "+d+"</h4><strong>"+a.bno+"</strong></div>"}));t.call(B);var C=A.selectAll("rect").data(function(a){return a.values}).enter().append("rect").attr("class","bar").style("fill",function(a,b){return a.cc}).attr("x",function(a,b){return o(a.bno)}).attr("y",function(a){return q(a.y)}).style("opacity",z).attr("width",o.rangeBand()).attr("height",function(a){return q(a.y0)-q(a.y0+a.y)}).on("mouseover",B.show).on("mouseout",B.hide),D=d3.svg.brush().x(p).extent([g/4,g]).on("brush",function(){var a=D.extent(),b=Math.floor(a[0]/r),c=Math.floor(a[1]/r),d=k.filter(function(a,d){return d>=b&&c>=d}),e=d.map(function(a){return a[0]});e.length>0&&(o.domain(e),C.data(function(a){return a.values}).attr("x",function(a,b){return o(a.bno)}).attr("height",function(a,d){return b>d||d>c?0:q(a.y0)-q(a.y)}).attr("width",o.rangeBand()),w.tickValues(v(d)),t.select(".x.axis").call(w))}),E=u.selectAll(".layer2").data(layers(k,l)).enter().append("g").attr("class","layer2"),F=E.selectAll("rect").data(function(a){return a.values}).enter().append("rect").attr("x",function(a,b){return o(a.bno)}).attr("y",function(a,b){return q(a.y)/4}).style("fill",function(a,b){return a.cc}).style("opacity",z).attr("width",o.rangeBand()).attr("height",function(a){return(q(a.y0)-q(a.y0+a.y))/4}),E=u.append("g").attr("class","x axis").attr("transform","translate(0,"+i+")").call(x);E.append("g").attr("class","x brush").call(D).call(D.event).selectAll("rect").attr("y",-1*(i+10)).attr("height",30),C.on("click",function(d,e){a.selectedBuildObj=a.versionBuilds[e],b.search("build",a.selectedBuildObj.Version),b.search("excluded_platforms",null),b.search("excluded_categories",null),a.refreshSidebar=!0,a.refreshJobs=!0,C.transition().delay(1).style("opacity",z),F.transition().delay(1).style("opacity",z),c.$apply()}),t.append("g").attr("class","x axis grid").attr("transform","translate(0,"+h+")").call(w),t.append("g").attr("class","y axis grid").attr("transform","translate(10,0)").call(y)}function d(a,b,d){a.$watch("buildData",function(a){console.log(a)}),a.$watch("data.timelineAbsData",function(d){void 0!=d&&d.length>0&&(d3.select(b[0]).select("svg").remove(),c(a,d,b[0]))},!0)}var e={top:50,right:10,bottom:150,left:50},f={top:150,right:10,bottom:20,left:50},g=860-e.left-e.right,h=270-e.top-e.bottom,i=270-f.top-f.bottom;return{link:d,restrict:"E",scope:{buildData:"=builds"}}}]).directive("pieChart",[function(){function a(a,b,c){var d=d3.scale.category10(),e=[10,20,30],f=150,g=150,h=Math.min(f,g),i=d3.select(b[0]).append("svg"),j=d3.layout.pie().sort(null),k=d3.svg.arc().outerRadius(h/2*.9).innerRadius(h/2*.5);i.attr({width:f,height:g});var l=i.append("g").attr("transform","translate("+f/2+","+g/2+")");l.selectAll("path").data(j(e)).enter().append("path").style("stroke","white").attr("d",k).attr("fill",function(a,b){return d(b)})}return{link:a,restrict:"E",scope:!1}}]),angular.module("svc.data",[]).provider("Data",[function(){this.versions=[],this.bucket="server",this.selectedVersion=null,this.versionBuilds=[],this.selectedBuildObj=null,this.timelineAbsData=[],this.timelineRelData=[],this.refreshSidebar=!1,this.refreshTimeline=!1,this.refreshJobs=!1,this.$get=function(){return{setBucket:function(a){this.bucket=a},findBuildObj:function(a){var b,c=this.versionBuilds.filter(function(b){return b.Version==a?!0:void 0});return b=0==c.length?this.lastVersionBuild():c[0]},bucket:"server",lastVersionBuild:function(){return lastEl(this.versionBuilds)},knownPlatforms:[],knownCategories:[]}}}]),angular.module("ctl.initdata",[]).controller("InitDataCtrl",["$scope","ViewService","Data","$location",function(a,b,c,d){function e(){a.filterMenues=[{title:"Total Passed",key:"abspassed",value:200,options:[0,100,200,500],i:0},{title:"Total Failed",key:"absfailed",value:25,options:[0,10,25,50],i:1},{title:"Perc. Passed",key:"percpassed",value:50,options:[0,25,50,75],i:2},{title:"Perc. Failed",key:"percfailed",value:25,options:[0,10,25,50],i:3}],a.filterBy=a.filterMenues[0]}function f(){b.categories().then(function(a){c.knownPlatforms=a.data.platforms,c.knownCategories=a.data.components}),i().then(m)}var g=null,h=d.search();"version"in h&&(g=h.version);e(),"fi"in h&&"fv"in h&&(a.filterBy=a.filterMenues[h.fi],a.filterBy.value=h.fv);var i=function(){return b.versions().then(function(b){c.versions=b,g?c.selectedVersion=g:c.selectedVersion=b[b.length-2],a.selectedVersion=c.selectedVersion})},j=function(){var e=a.filterBy,f=c.selectedVersion;return b.timeline(f,e).then(function(b){if(b.allBuilds.length>0&&0==b.versionBuilds.length){var e=a.filterBy.options,f=e.indexOf(a.filterBy.value);if(f>0)return a.filterBy.value=e[f-1],d.search("fv",a.filterBy.value),j()}c.timelineAbsData=b.absData,c.timelineRelData=b.relData,c.versionBuilds=b.versionBuilds,"build"in h?c.selectedBuildObj=c.findBuildObj(h.build):c.selectedBuildObj=c.lastVersionBuild()})},k=function(){d.search("fi",null),d.search("fv",null),d.search("ft",null),d.search("version",null),d.search("build",null),d.search("excluded_platforms",null),d.search("excluded_categories",null),h={}},l=function(){d.search("version",c.selectedVersion),d.search("build",c.selectedBuildObj.Version),d.search("fi",a.filterBy.i),d.search("fv",a.filterBy.value),d.search("ft",a.targetBy.i)},m=function(){j().then(function(){l(),c.refreshSidebar=!0,c.refreshTimeline=!0,c.refreshJobs=!0})},n=function(){d.search("excluded_platforms",null),d.search("excluded_categories",null)};a.didSelectVersion=function(b){k(),_b=c.bucket,c.bucket=_b,n(),c.selectedVersion=b,a.selectedVersion=b,m()},a.didSelectFilter=function(b){a.filterBy.value=b,n(),m()},a.didSelectMenu=function(b){a.filterBy=b,m()},a.didSelectTarget=function(b){k(),a.targetBy=b,c.bucket=b.bucket,f()},f()}]),angular.module("ctl.jobs",[]).controller("JobsCtrl",["$scope","ViewService","Data","$location",function(a,b,c,d){function e(){if(!a.runningJobs){a.runningJobs=!0;var e=c.selectedBuildObj.Version;a.jobs=[],a.missingJobs=[];var f={};a.testsPassed=0,a.testsTotal=0;var g=function(b,c,d){b.forEach(function(b){-1==b.Bid&&(b.Bid=""),b.Name in f||(b.Url.indexOf("macbuild")>-1&&(b.Url="https://macbuild.hq.couchbase.com/",b.Bid=""),f[b.Name]=!0,c.push({name:b.Name,passed:b.Passed,total:b.Total,result:b.Result,priority:b.Priority,url:b.Url,bid:b.Bid,duration:msToTime(b.Duration),claim:b.Claim}),d?a.testsPending+=b.Total:(a.testsPassed+=b.Passed,a.testsTotal+=b.Total))})},h=d.search(),i=[],j=[];"excluded_platforms"in h&&(i=h.excluded_platforms.split(",")),"excluded_categories"in h&&(j=h.excluded_categories.split(",")),b.jobs(e,i,j).then(function(c){c.sort(function(a,b){if(a.Bid&&b.Bid){if(a.Bid>b.Bid)return-1;if(a.Bid<b.Bid)return 1}return 0}),g(c,a.jobs,!1),a.jobsCompleted=a.jobs.length,b.jobs_missing(e,i,j).then(function(b){a.testsPending=0,g(b,a.missingJobs,!0),a.jobsPending=a.missingJobs.length,a.runningJobs=!1})})}}a.data=c,a.jobsPending=0,a.jobsCompleted=0,a.$watch("data.refreshJobs",function(a,b){1==a&&(e(),c.refreshJobs=!1)}),a.nameSort=function(a){return a.name},a.predicate=a.nameSort}]),angular.module("ctl.main",["svc.targets"]).controller("MainCtrl",["$scope","$location","$stateParams","ViewTargets","Data","versions",function(a,b,c,d,e,f){var g=c.target;a.targetBy=d.getTarget(g),d.setTarget(g),a.viewTargets=d.allTargets(),a.pagerVersions=f,e.setBucket(g)}]),angular.module("svc.query",[]).service("QueryService",["$http","Data",function(a,b){return{getVersions:function(b){var c=["versions",b].join("/");return a({url:c,cache:!0}).then(function(a){return a.data})},getBuilds:function(b,c){var d=["builds",b,c].join("/");return a({url:d,cache:!0}).then(function(a){return a.data})}}}]),angular.module("ctl.sidebar",[]).controller("SidebarCtrl",["$scope","ViewService","Data","$location",function(a,b,c,d){function e(b,c){var d,e;"c"==c?(e=b.Category,d=a.Categories[e]):(e=b.Platform,d=a.Platforms[e]),d.checked?d.Status="greyed":d.Status="bg-success",d.checked=!d.checked}a.data=c,a.showAsPerc=!0,a.showAllPlatforms=!0,a.showAllCategories=!0,a.PlatformsList=[],a.CategoriesList=[],a.didFirstSort=!1,a.orderByPerc=function(b){return a.didFirstSort?b.sortOrder:(b.sortOrder=-100*a.getPerc(b),b.sortOrder)},a.objAsList=function(a){var b=[];for(var c in a)b.push(a[c]);return b};var f=function(){a.selectedVersion=c.selectedVersion,a.build=c.selectedBuildObj,a.build.Passed=0,a.build.Failed=0,a.build.Pending=0,a.showAllPlatforms=!0,a.showAllCategories=!0,c.selectedBuildObj&&(a.Platforms={},a.Categories={},i().then(function(){var a=d.search(),b=!1;if("excluded_platforms"in a){b=!0;var c=a.excluded_platforms.split(",");c.forEach(function(a){e({Platform:a},"p")})}if("excluded_categories"in a){b=!0;var f=a.excluded_categories.split(",");f.forEach(function(a){e({Category:a},"c")})}b&&j()}))};a.$watch("data.refreshSidebar",function(b,d){1==b?(f(),c.refreshSidebar=!1):a.didFirstSort=!1}),a.didClickSlider=function(){a.showAsPerc=!a.showAsPerc},a.getPercVal=function(a,b){if(!a)return 0;var c=a.Passed+a.Failed;return 0==c?0:100*(b/c)},a.getPerc=function(a){if(!a)return 0;var b=a.Passed+a.Failed,c=b+a.Pending;return 0==c?0:b/c};var g=function(b){a.Categories[b.Category].Passed+=b.Passed,a.Categories[b.Category].Failed+=b.Failed,a.Categories[b.Category].Pending+=b.Pending,a.Platforms[b.Platform].Passed+=b.Passed,a.Platforms[b.Platform].Failed+=b.Failed,a.Platforms[b.Platform].Pending+=b.Pending,a.build.Passed+=b.Passed,a.build.Failed+=b.Failed,a.build.Pending+=b.Pending},h=function(b){var c="bg-success",d="bg-warning",e="bg-danger";if("greyed"!=a.Platforms[b.Platform].Status){var f=a.Platforms[b.Platform].Failed;if(f>0){var g=a.Platforms[b.Platform].Passed,h=100*f/(f+g);h>30?a.Platforms[b.Platform].Status=e:a.Platforms[b.Platform].Status=d}else a.Platforms[b.Platform].Status=c}if(0==a.Platforms[b.Platform].Passed&&0==a.Platforms[b.Platform].Failed&&(a.Platforms[b.Platform].Status="disabled"),"greyed"!=a.Categories[b.Category].Status){var f=a.Categories[b.Category].Failed;if(f>0){var g=a.Categories[b.Category].Passed,h=100*f/(f+g);h>30?a.Categories[b.Category].Status=e:a.Categories[b.Category].Status=d}else a.Categories[b.Category].Status=c}0==a.Categories[b.Category].Passed&&0==a.Categories[b.Category].Failed&&(a.Categories[b.Category].Status="disabled");var f=a.build.Failed;if(0==f)a.build.Status=c;else{var g=a.build.Passed,h=100*f/(f+g);h>30?a.build.Status=e:a.build.Status=d}},i=function(d,e){return b.breakdown(c.selectedBuildObj.Version,d,e).then(function(b){b.forEach(function(b){b.Category in a.Categories||(a.Categories[b.Category]={Category:b.Category,Passed:0,Failed:0,Pending:0,Status:"bg-success",checked:!0}),b.Platform in a.Platforms||(a.Platforms[b.Platform]={Platform:b.Platform,Passed:0,Failed:0,Pending:0,Status:"bg-success",checked:!0}),g(b),h(b)})})},j=function(){c.selectedBuildObj.Version;a.build.Passed=0,a.build.Failed=0,a.build.Pending=0,a.build.Status="bg-success";var b=[],e=[];Object.keys(a.Categories).forEach(function(b){var c=a.Categories[b];c.Passed=0,c.Failed=0,c.Pending=0,"greyed"==c.Status?e.indexOf(b)<0&&e.push(b):c.Status="disabled"}),Object.keys(a.Platforms).forEach(function(c){var d=a.Platforms[c];d.Passed=0,d.Failed=0,d.Pending=0,"greyed"==d.Status?b.indexOf(c)<0&&b.push(c):d.Status="disabled"}),b.length>0&&b.length==Object.keys(a.Platforms).length?a.showAllPlatforms=!1:0==b.length&&(a.showAllPlatforms=!0),e.length>0&&e.length==Object.keys(a.Categories).length?a.showAllCategories=!1:0==e.length&&(a.showAllCategories=!0);var f=null,g=null;return b.length>0&&(f=b.toString()),e.length>0&&(g=e.toString()),d.search("excluded_platforms",f),d.search("excluded_categories",g),c.refreshJobs=!0,i(b,e)};a.toggleAll=function(b){var c;"c"==b?(c=a.Categories,a.showAllCategories=!a.showAllCategories):(c=a.Platforms,a.showAllPlatforms=!a.showAllPlatforms),Object.keys(c).forEach(function(d){var f=c[d];"c"==b?f.checked=!a.showAllCategories:f.checked=!a.showAllPlatforms,e(f,b)}),j()},a.toggleItem=function(b,c){if(a.didFirstSort=!0,"c"==c){var d=Object.keys(a.Categories),f=d.filter(function(b){return a.Categories[b].checked});f.length>1&&f.length==d.length&&a.toggleAll("c")}else{var g=Object.keys(a.Platforms),f=g.filter(function(b){return a.Platforms[b].checked});f.length>1&&f.length==g.length&&a.toggleAll("p")}e(b,c),j()}}]),angular.module("ctl.target",["dir.d3","svc.targets"]).controller("TargetCtrl",["$scope","$location","ViewTargets",function(a,b,c){a.viewTargets=c.getTargets,a.targetBy=c.defaultTarget,console.log(a.targetBy);var d=b.search();"ft"in d&&(a.targetBy=a.viewTargets[d.ft])}]),angular.module("svc.targets",[]).provider("ViewTargets",[function(){var a=[{title:"Couchbase Server",bucket:"server",key:"abspassed",value:100,options:[0,50,100,500]},{title:"SDK",bucket:"sdk",key:"abspassed",value:0,options:[0,50,100,500]},{title:"Mobile",bucket:"mobile",key:"abspassed",value:0,options:[0,50,100,500]}],b={};a=a.map(function(a,c){return a.i=c,b[a.bucket]=a,a}),this.currentTarget=a[0],this.$get=function(){return{currentTarget:this.currentTarget,allTargets:function(){return a},getTarget:function(a){return b[a]},setTarget:function(a){this.currentTarget=a}}}}]),angular.module("ctl.timeline",["dir.d3"]).controller("TimelineCtrl",["$scope","ViewService","Data","$location",function(a,b,c,d){function e(){a.activeBars.forEach(function(a){d3.select(a).style("fill-opacity",function(a,b){return.5})})}function f(b){e(),a.activeBars=[];var d=c.versionBuilds.length,f=d3.selectAll("#absTimeline rect.nv-bar")[0];a.activeBars.push(f[b]),a.activeBars.push(f[b+d]),a.activeBars.forEach(function(a){d3.select(a).style("fill-opacity",function(a,b){return 1})});var f=d3.selectAll("#relTimeline rect.nv-bar")[0];a.activeBars.push(f[b]),a.activeBars.push(f[b+d]),a.activeBars.push(f[b+2*d]),a.activeBars.forEach(function(a){d3.select(a).style("fill-opacity",function(a,b){return 1})})}a.data=c,a.activeBars=[],a.reverse=!0,a.$watch("data.refreshTimeline",function(a,b){1==a&&(g(),c.refreshTimeline=!1)});var g=function(){var b=function(a){return a.values=a.values.map(function(a){var b=a[0].split("-");return a[0]=b[b.length-1],a}),a};a.timelineAbsData=c.timelineAbsData.map(b),a.timelineRelData=c.timelineRelData.map(b),e()};a.$on("barClick",function(b,e){c.selectedBuildObj=c.versionBuilds[e.pointIndex],f(e.pointIndex),d.search("build",c.selectedBuildObj.Version),d.search("excluded_platforms",null),d.search("excluded_categories",null),c.refreshSidebar=!0,c.refreshJobs=!0,a.$apply()});var h=d3.format("f");a.yAxisTickFormatFunction=function(){return function(a){return h(Math.abs(a))}},a.relToolTipContentFunction=function(){return function(a,b,c){return"<h4>"+c+"% "+a.replace(", %","")+"</h4><p>Build "+b+"</p>"}},a.absToolTipContentFunction=function(){return function(a,b,d,e){var f=c.versionBuilds[e.pointIndex].AbsPassed+c.versionBuilds[e.pointIndex].AbsFailed;return"<h4>"+d+" of "+f+" Tests "+a+"</h4><p>Build "+b+"</p>"}},a.xFunction=function(){return function(a){return a.key}},a.yFunction=function(){return function(a){return a.value}}}]),angular.module("ctl.version",[]).controller("VersionCtrl",["$scope","QueryService","ViewTargets","selectedVersion",function(a,b,c,d){var e=c.currentTarget;a.data={},console.log("getBuilds"),b.getBuilds(e,d).then(function(b){a.builds=b})}]),angular.module("svc.view",[]).service("ViewService",["$http","Data",function(a,b){var c=function(a,b,c){return b&&b.length>0&&(a=a.filter(function(a){return b.indexOf(a.Platform)>-1?!1:!0})),c&&c.length>0&&(a=a.filter(function(a){return c.indexOf(a.Category)>-1?!1:!0})),a};return{versions:function(){var c={url:"/versions/"+b.bucket};return a(c).then(function(a){var b=a.data;return Object.keys(b)})},timeline:function(c,d,e){var f={url:"/timeline/"+c+"/"+b.bucket,cache:!0};return a(f).then(function(a){var b,e,f,g,h=a.data;f=[{key:"Passed",values:[]},{key:"Failed",values:[]}],g=[{key:"Tests Failed, %",values:[]},{key:"Tests Passed, %",values:[]},{key:"Jobs Executed, %",values:[]}],b=h.map(function(a){return a.Version});var i=function(a){f[0].values.push([a.Version,a.AbsPassed]),f[1].values.push([a.Version,-a.AbsFailed]),g[0].values.push([a.Version,a.RelFailed]),g[1].values.push([a.Version,a.RelPassed]),g[2].values.push([a.Version,a.RelExecuted])};return e=h.filter(function(a){if(a.Version.indexOf(c)>-1){if("abspassed"==d.key&&a.AbsPassed>=d.value)return i(a),!0;if("absfailed"==d.key&&a.AbsFailed>=d.value)return i(a),!0;if("percpassed"==d.key&&a.RelPassed>=d.value)return i(a),!0;if("percfailed"==d.key&&a.RelFailed>=d.value)return i(a),!0}}),{allBuilds:b,versionBuilds:e,absData:f,relData:g}})},breakdown:function(d,e,f){var g={url:"/breakdown/"+d+"/"+b.bucket,cache:!0};return a(g).then(function(a){return c(a.data,e,f)})},jobs:function(d,e,f){var g={url:"/jobs/"+d+"/"+b.bucket,cache:!0};return a(g).then(function(a){return c(a.data,e,f)})},categories:function(){var c={url:"/categories/"+b.bucket,cache:!0};return a(c)},jobs_missing:function(d,e,f){var g={url:"/jobs_missing/"+d+"/"+b.bucket,cache:!1};return a(g).then(function(a){return c(a.data,e,f)})}}}]);